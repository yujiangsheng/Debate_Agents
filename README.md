# 🎯 智能辩论系统 (Debate Agents)

基于 **Qwen2.5-7B-Instruct** 的多智能体辩论系统。两个AI智能体从不同角度讨论问题，裁判进行犀利评判，最终输出共识点和分歧点。

**作者**: Jiangsheng Yu

---

## 📋 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      🎯 辩论系统                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│    ┌──────────┐    辩论    ┌──────────┐                    │
│    │ 智能体A  │◄─────────►│ 智能体B  │                    │
│    │  (正方)  │           │  (反方)  │                    │
│    └────┬─────┘           └────┬─────┘                    │
│         │                      │                           │
│         └───────┐    ┌────────┘                           │
│                 ▼    ▼                                     │
│              ┌──────────┐                                  │
│              │ ⚖️ 裁判C │                                  │
│              │ (犀利评判)│                                  │
│              └────┬─────┘                                  │
│                   ▼                                        │
│            ┌────────────┐                                  │
│            │ 📊 最终总结 │                                  │
│            │ 共识 & 分歧│                                  │
│            └────────────┘                                  │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  🔧 工具层:  Google搜索  │  RAG检索  │  Qwen2.5-7B        │
└─────────────────────────────────────────────────────────────┘
```

---

## ✨ 核心特性

| 特性 | 说明 |
|------|------|
| 🤖 **多智能体辩论** | 正方A vs 反方B 对立辩论，自动分配立场 |
| ⚖️ **犀利裁判** | 尖锐评判，明确判定胜负，不和稀泥 |
| 🤝 **共识提炼** | 自动总结共识点和分歧点 |
| 🖥️ **设备自适应** | GPU > MPS > CPU 自动选择最佳设备 |
| 🔧 **工具增强** | 支持 Google 搜索和 RAG 知识库 |
| 💾 **单例模式** | 模型只加载一次，多智能体共享，节省资源 |

---

## 🚀 快速开始

### 1. 环境准备

```bash
# 克隆项目
git clone <repo_url>
cd Debate_Agents

# 创建虚拟环境 (推荐)
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# .venv\Scripts\activate   # Windows

# 安装依赖
pip install -r requirements.txt
```

### 2. 运行辩论

```bash
# 交互模式 - 连续进行多场辩论
python main.py

# 指定主题 - 单次辩论
python main.py -t "人工智能是否会取代人类工作"

# 指定轮数 - 3轮深度辩论
python main.py -t "远程办公的利弊" -r 3

# 启用搜索工具 - 获取实时信息
python main.py -t "2024年科技趋势" --use-tools
```

---

## 📖 详细使用说明

### 命令行参数

| 参数 | 简写 | 说明 | 默认值 |
|------|------|------|--------|
| `--topic` | `-t` | 辩论主题 | 无 (进入交互模式) |
| `--rounds` | `-r` | 最大辩论轮数 | 5 |
| `--use-tools` | | 启用搜索和RAG工具 | 否 |
| `--no-search` | | 禁用网络搜索 | 否 |
| `--no-rag` | | 禁用RAG知识库 | 否 |
| `--no-early-stop` | | 禁用共识后提前结束 | 否 |
| `--knowledge-file` | `-k` | 知识库文件路径 | 无 |
| `--output` | `-o` | 结果导出路径 (.json/.md) | 无 |

### 使用场景示例

```bash
# 场景1: 快速体验 - 交互模式
python main.py

# 场景2: 单次深度辩论
python main.py -t "是否应该全面禁止塑料袋" -r 5

# 场景3: 启用工具获取实时信息
python main.py -t "加密货币是否应该合法化" --use-tools

# 场景4: 使用本地知识库
python main.py -t "公司战略规划" -k ./knowledge.txt

# 场景5: 禁用提前结束，完整辩论
python main.py -t "教育改革方向" --no-early-stop

# 场景6: 导出结果到JSON文件
python main.py -t "人工智能伦理" -o result.json

# 场景7: 导出结果到Markdown文件
python main.py -t "远程办公利弊" -o debate_report.md
```

### Python API 调用

```python
from debate_system import DebateSystem

# 创建系统实例
system = DebateSystem(use_search=True, use_rag=True)

# 运行辩论
result = system.run_debate(
    topic="人工智能是否会取代人类工作？",
    max_rounds=5,
    use_tools=False,
    early_stop=True
)

# 获取结果
print(result['final_summary'])  # 最终总结
print(result['rounds'])         # 实际轮数
print(result['history'])        # 完整历史
```

---

## 📁 项目结构

```
Debate_Agents/
├── main.py              # 主入口 - 命令行接口
├── debate_system.py     # 辩论系统 - 核心调度
├── model_loader.py      # 模型加载器 - 单例模式
├── config.py            # 全局配置 - 参数设置
├── exceptions.py        # 异常定义 - 错误处理
├── utils.py             # 工具函数 - 导出/文本处理
├── requirements.txt     # 依赖列表
├── README.md            # 说明文档
│
├── agents/              # 智能体模块
│   ├── __init__.py      # 模块导出
│   ├── base_agent.py    # 基类 - 通用功能
│   ├── debate_agents.py # 辩论者 A & B
│   └── judge_agent.py   # 裁判 C
│
└── tools/               # 工具模块
    ├── __init__.py      # 模块导出
    ├── search_tool.py   # 网络搜索
    └── rag_tool.py      # RAG 检索
```

### 模块说明

| 模块 | 功能 |
|------|------|
| `main.py` | 命令行入口，参数解析 |
| `debate_system.py` | 辩论流程调度，控制多轮辩论 |
| `model_loader.py` | Qwen 模型封装，单例模式 |
| `config.py` | 全局配置，支持环境变量 |
| `exceptions.py` | 自定义异常类 |
| `utils.py` | 结果导出、文本处理工具 |
| `agents/` | 智能体实现 (正方/反方/裁判) |
| `tools/` | 外部工具 (搜索/RAG) |

---

## ⚙️ 配置说明

### 环境变量配置

支持通过环境变量覆盖默认配置：

```bash
# 模型配置
export DEBATE_MODEL_NAME="Qwen/Qwen2.5-7B-Instruct"

# 生成参数
export DEBATE_MAX_TOKENS="1024"
export DEBATE_TEMPERATURE="0.7"
export DEBATE_TOP_P="0.9"

# 辩论参数
export DEBATE_MAX_ROUNDS="5"
export DEBATE_CONSENSUS_THRESHOLD="0.8"
```

### 配置文件

在 `config.py` 中可调整以下参数:

```python
# =============================================================================
# 模型配置
# =============================================================================
MODEL_NAME = "Qwen/Qwen2.5-7B-Instruct"  # 使用的大语言模型

# =============================================================================
# 生成参数 - 控制模型输出
# =============================================================================
GENERATION_CONFIG = {
    "max_new_tokens": 1024,    # 最大生成长度
    "temperature": 0.7,        # 温度 (0.1-1.0, 越高越随机)
    "top_p": 0.9,              # 核采样参数
    "do_sample": True,         # 是否采样
    "repetition_penalty": 1.1, # 重复惩罚
}

# =============================================================================
# 辩论参数
# =============================================================================
MAX_DEBATE_ROUNDS = 5        # 最大辩论轮数
CONSENSUS_THRESHOLD = 0.8    # 共识阈值 (达到后提前结束)

# =============================================================================
# 工具配置
# =============================================================================
RAG_TOP_K = 3                # RAG 检索返回文档数
SEARCH_NUM_RESULTS = 5       # 搜索返回结果数
```

---

## 💻 硬件要求

| 设备 | 要求 | 说明 |
|------|------|------|
| **GPU (推荐)** | NVIDIA GPU, 16GB+ 显存 | 使用 float16，速度最快 |
| **Apple MPS** | Apple Silicon, 16GB+ 内存 | 使用 float32，M1/M2/M3 适用 |
| **CPU** | 32GB+ 内存 | 速度较慢，作为兜底方案 |

> 💡 系统会自动检测并选择最佳设备

---

## 📝 辩论流程

```
1. 用户输入辩论主题
         ↓
2. 智能体A发言 (正方立场)
   - 阐述立场
   - 提出论据
         ↓
3. 智能体B发言 (反方立场)
   - 阐述立场
   - 反驳对方
         ↓
4. 裁判C犀利评判
   - 点评双方表现
   - 指出逻辑漏洞
   - 判定本轮胜负
         ↓
5. 检查共识度
         ↓
   ┌─────┴─────┐
   ↓           ↓
 达成共识    未达成
   ↓           ↓
 结束      继续下一轮
         ↓
6. 最终总结
   - 共识点
   - 分歧点
   - 综合结论
```

---

## 📄 示例输出

```
╭─────────────────── 📋 辩论主题 ───────────────────╮
│ 人类是否应该研究具有自主能力的人工智能？           │
╰───────────────────────────────────────────────────╯

🔄 第 1 轮辩论
============================================================

【🅰️ 智能体A发言】
┌─────────────────────────────────────────────────────────┐
│ 【我的立场】支持研究自主AI                               │
│                                                         │
│ 【核心论据】                                            │
│ 1. 自主AI能推动医疗、环保等领域的科技进步...            │
│ 2. 帮助解决气候变化等复杂全球问题...                    │
└─────────────────────────────────────────────────────────┘

【🅱️ 智能体B发言】
┌─────────────────────────────────────────────────────────┐
│ 【我的立场】反对盲目研究                                 │
│                                                         │
│ 【核心论据】                                            │
│ 1. 存在失控风险，可能导致严重后果...                    │
│ 2. 法律框架滞后于技术发展...                            │
└─────────────────────────────────────────────────────────┘

【⚖️ 裁判C评判】
┌─────────────────────────────────────────────────────────┐
│ 【犀利点评】双方都在回避核心问题...                     │
│ 【本轮胜负】A方略胜，论据更具体                         │
│ 【共识进展】双方都认可需要风险控制                      │
└─────────────────────────────────────────────────────────┘

...

╭─────────────── 📊 最终总结 - 共识与分歧 ───────────────╮
│                                                         │
│ 【共识点】                                              │
│ • 自主AI具有潜在价值                                   │
│ • 需要在安全可控的前提下研究                           │
│                                                         │
│ 【分歧点】                                              │
│ • A方认为应积极推进，B方主张更谨慎                     │
│                                                         │
╰─────────────────────────────────────────────────────────╯
```

---

## 🔧 常见问题

### Q: 模型下载很慢怎么办？
A: 可以设置 HuggingFace 镜像：
```bash
export HF_ENDPOINT=https://hf-mirror.com
```

### Q: 显存不足怎么办？
A: 可以尝试：
1. 使用更小的模型 (修改 `config.py` 中的 `MODEL_NAME`)
2. 减少 `max_new_tokens` 参数
3. 使用 CPU 模式 (会自动降级)

### Q: 如何添加自定义知识库？
A: 使用 `-k` 参数指定知识库文件：
```bash
python main.py -t "主题" -k ./my_knowledge.txt
```

### Q: 搜索功能不可用？
A: 确保安装了搜索依赖：
```bash
pip install googlesearch-python requests beautifulsoup4
```

---

## 🛠️ 开发指南

### 自定义智能体

继承 `BaseAgent` 类创建自定义智能体：

```python
from agents.base_agent import BaseAgent

class MyAgent(BaseAgent):
    def __init__(self):
        super().__init__(name="自定义智能体", role="特殊角色")
    
    def _build_system_prompt(self) -> str:
        return "你是一个自定义智能体..."
```

### 添加新工具

在 `tools/` 目录下创建新工具：

```python
class MyTool:
    def __init__(self):
        pass
    
    def execute(self, query: str) -> str:
        # 实现工具逻辑
        return "结果"
```

---

## 📜 License

MIT License

---

## 👤 作者

**Jiangsheng Yu**

如有问题或建议，欢迎提交 Issue 或 PR。
